#!/usr/bin/env php
<?php
require_once(__DIR__.'/common.php');

// Database
$cursor = $db->querySingle('SELECT cursor FROM cursor');
$add_stmt = $db->prepare("INSERT INTO temp (ts, value) VALUES (?,?)");
$cursor_stmt = $db->prepare("UPDATE cursor SET cursor=?");


print("$cursor\n");

while (true) {
    $line = fgets(STDIN);
    if ($line === FALSE) {
        // It's over.
        break;
    }

    $vars = json_decode($line);
    if ($vars === NULL) {
        fwrite(STDERR, "Fatal: Not in systemd-like log format\n");
        break;
    }

    if ($vars->__CURSOR === $cursor) {
        // Due to systemd bug, sometimes --after-cursor print the
        // cursor data, too. Ignoring that data.
        fwrite(STDERR, "Ignoring: Duplicated packet\n");
        continue;
    }

    // Now inserting the data and updating the cursor position
    $db->exec('BEGIN');
    // Correct data. Store it.
    $data = [
        floor($vars->__REALTIME_TIMESTAMP / 1000000), // seconds
        $rtl_433->temperature_C,
    ];
    db_execute($add_stmt, $data);
    array_unshift($data, $db->lastInsertRowID());
    db_execute($cursor_stmt, [$vars->__CURSOR]);
    $db->exec('END');

}
